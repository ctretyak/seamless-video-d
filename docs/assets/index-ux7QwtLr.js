var M=Object.defineProperty;var T=(n,t,e)=>t in n?M(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var h=(n,t,e)=>T(n,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const c of s)if(c.type==="childList")for(const f of c.addedNodes)f.tagName==="LINK"&&f.rel==="modulepreload"&&i(f)}).observe(document,{childList:!0,subtree:!0});function e(s){const c={};return s.integrity&&(c.integrity=s.integrity),s.referrerPolicy&&(c.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?c.credentials="include":s.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function i(s){if(s.ep)return;s.ep=!0;const c=e(s);fetch(s.href,c)}})();class P{static parseJsonInCorrectFormat(t){const e=JSON.parse(t);if(!e.mainClips||!e.outcomeClips)throw new Error("Invalid JSON format. Missing mainClips or outcomeClips");return e}static parseJsonFromUrl(){try{const e=new URLSearchParams(window.location.search).get("json");return e?this.parseJsonInCorrectFormat(e):null}catch(t){return console.log("Error parsing JSON from URL",t),alert("Error parsing JSON from URL"),null}}constructor(t,e,i,s,c){i.value=JSON.stringify(t,null,2),document.addEventListener("keydown",function(f){f.code==="Backquote"&&e.classList.toggle("active")}),s.addEventListener("click",()=>{this.applyNewJson(i.value)}),c.addEventListener("click",()=>{const f=new URLSearchParams(window.location.search);f.delete("json"),window.location.search=f.toString()})}applyNewJson(t){try{const e=P.parseJsonInCorrectFormat(t),i=new URLSearchParams(window.location.search);i.set("json",JSON.stringify(e)),window.location.search=i.toString()}catch(e){alert("Invalid JSON"),console.error(e)}}}function z(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var A={exports:{}};(function(n){var t=Object.prototype.hasOwnProperty,e="~";function i(){}Object.create&&(i.prototype=Object.create(null),new i().__proto__||(e=!1));function s(d,o,a){this.fn=d,this.context=o,this.once=a||!1}function c(d,o,a,l,y){if(typeof a!="function")throw new TypeError("The listener must be a function");var v=new s(a,l||d,y),p=e?e+o:o;return d._events[p]?d._events[p].fn?d._events[p]=[d._events[p],v]:d._events[p].push(v):(d._events[p]=v,d._eventsCount++),d}function f(d,o){--d._eventsCount===0?d._events=new i:delete d._events[o]}function u(){this._events=new i,this._eventsCount=0}u.prototype.eventNames=function(){var o=[],a,l;if(this._eventsCount===0)return o;for(l in a=this._events)t.call(a,l)&&o.push(e?l.slice(1):l);return Object.getOwnPropertySymbols?o.concat(Object.getOwnPropertySymbols(a)):o},u.prototype.listeners=function(o){var a=e?e+o:o,l=this._events[a];if(!l)return[];if(l.fn)return[l.fn];for(var y=0,v=l.length,p=new Array(v);y<v;y++)p[y]=l[y].fn;return p},u.prototype.listenerCount=function(o){var a=e?e+o:o,l=this._events[a];return l?l.fn?1:l.length:0},u.prototype.emit=function(o,a,l,y,v,p){var w=e?e+o:o;if(!this._events[w])return!1;var r=this._events[w],C=arguments.length,E,m;if(r.fn){switch(r.once&&this.removeListener(o,r.fn,void 0,!0),C){case 1:return r.fn.call(r.context),!0;case 2:return r.fn.call(r.context,a),!0;case 3:return r.fn.call(r.context,a,l),!0;case 4:return r.fn.call(r.context,a,l,y),!0;case 5:return r.fn.call(r.context,a,l,y,v),!0;case 6:return r.fn.call(r.context,a,l,y,v,p),!0}for(m=1,E=new Array(C-1);m<C;m++)E[m-1]=arguments[m];r.fn.apply(r.context,E)}else{var S=r.length,D;for(m=0;m<S;m++)switch(r[m].once&&this.removeListener(o,r[m].fn,void 0,!0),C){case 1:r[m].fn.call(r[m].context);break;case 2:r[m].fn.call(r[m].context,a);break;case 3:r[m].fn.call(r[m].context,a,l);break;case 4:r[m].fn.call(r[m].context,a,l,y);break;default:if(!E)for(D=1,E=new Array(C-1);D<C;D++)E[D-1]=arguments[D];r[m].fn.apply(r[m].context,E)}}return!0},u.prototype.on=function(o,a,l){return c(this,o,a,l,!1)},u.prototype.once=function(o,a,l){return c(this,o,a,l,!0)},u.prototype.removeListener=function(o,a,l,y){var v=e?e+o:o;if(!this._events[v])return this;if(!a)return f(this,v),this;var p=this._events[v];if(p.fn)p.fn===a&&(!y||p.once)&&(!l||p.context===l)&&f(this,v);else{for(var w=0,r=[],C=p.length;w<C;w++)(p[w].fn!==a||y&&!p[w].once||l&&p[w].context!==l)&&r.push(p[w]);r.length?this._events[v]=r.length===1?r[0]:r:f(this,v)}return this},u.prototype.removeAllListeners=function(o){var a;return o?(a=e?e+o:o,this._events[a]&&f(this,a)):(this._events=new i,this._eventsCount=0),this},u.prototype.off=u.prototype.removeListener,u.prototype.addListener=u.prototype.on,u.prefixed=e,u.EventEmitter=u,n.exports=u})(A);var J=A.exports;const b=z(J);class B{constructor(t){h(this,"src");h(this,"video",document.createElement("video"));this.src=t}load(){return this.video.playsInline=!0,this.video.preload="auto",this.video.controls=!1,this.video.autoplay=!0,this.video.src=this.src,this.video.pause(),new Promise(t=>{const e=()=>{this.video.removeEventListener("canplay",e);const i=()=>{this.video.removeEventListener("canplaythrough",i),t(this.video)};this.video.addEventListener("canplaythrough",i)};this.video.addEventListener("canplay",e)})}updateClipScale(t,e){const{videoWidth:i,videoHeight:s}=this.video,c=Math.min(e/i,t/s)||.1;return this.video.width=i*c,this.video.height=s*c,{width:this.video.width,height:this.video.height}}}class F extends b{constructor({parentElem:e,resizeTo:i=window}){super();h(this,"INACTIVE_Z_INDEX","0");h(this,"ACTIVE_Z_INDEX","1");h(this,"rootElem");h(this,"progress");h(this,"resizeTo");h(this,"clips",[]);h(this,"currentClip");h(this,"width",0);h(this,"height",0);this.resizeTo=i,this.rootElem=document.createElement("div"),this.rootElem.classList.add("svg-player"),this.progress=document.createElement("div"),this.progress.classList.add("progress-bar"),(e||document.body).appendChild(this.rootElem),this.rootElem.appendChild(this.progress)}addClips(e){const i=e.map(s=>s.convert(c=>new B(c)));return this.clips.push(...i.flatMap(s=>s.getAllValues())),i}async play(e){if(!this.clips.includes(e))throw new Error("Clip not found");return e.video.play(),e.video.style.zIndex=this.ACTIVE_Z_INDEX,this.currentClip&&(this.currentClip.video.style.zIndex=this.INACTIVE_Z_INDEX),this.currentClip=e,new Promise(i=>{const s=()=>{const{currentTime:c,duration:f}=e.video;if(this.progress.style.width=(c/f*100).toFixed(2)+"%",e.video.ended){i(),setTimeout(()=>{e.video.pause(),e.video.currentTime=0},100);return}this.updateClipScales(),window.requestAnimationFrame(s)};window.requestAnimationFrame(s)})}async load(){await Promise.all(Object.values(this.clips).map(e=>(e.video.style.zIndex=this.INACTIVE_Z_INDEX,e.video.style.position="absolute",e.video.style.top="0",e.video.style.left="0",this.rootElem.appendChild(e.video),e.load()))),this.updateClipScales(),this.emit("loaded")}updateClipScales(){const e=this.resizeTo instanceof Window?window.innerWidth:this.resizeTo.offsetWidth,i=this.resizeTo instanceof Window?window.innerHeight:this.resizeTo.offsetHeight,s=this.clips.map(u=>u.updateClipScale(i||window.innerHeight,e||window.innerWidth)),c=Math.max(...s.map(u=>u.width)),f=Math.max(...s.map(u=>u.height));(c!==this.width||f!==this.height)&&(this.width=c,this.height=f,this.rootElem.style.width=`${this.width}px`,this.rootElem.style.height=`${this.height}px`,this.emit("resize",{width:this.width,height:this.height}))}}class R extends b{constructor({mainClips:e,outcomeClips:i},s){super();h(this,"seamlessPlayer");h(this,"mainClips");h(this,"outcomeClips");h(this,"currentMainClips");h(this,"currentOutcomeClips");this.seamlessPlayer=new F({parentElem:s}),this.mainClips=this.seamlessPlayer.addClips(e),this.outcomeClips=this.seamlessPlayer.addClips(i),this.seamlessPlayer.on("loaded",()=>{this.emit("loaded")}),this.seamlessPlayer.on("resize",(...c)=>{this.emit("resize",...c)})}async play(){for(;;)await this.playNext()}async playOutcome(e){this.currentOutcomeClips=this.outcomeClips[e].getRandomPath()}async playNext(){var s;let e,i=!1;if(this.currentOutcomeClips?(e=this.currentOutcomeClips.shift(),this.currentOutcomeClips.length===0&&(this.currentOutcomeClips=void 0),i=!0):(e=(s=this.currentMainClips)==null?void 0:s.shift(),e||(this.currentMainClips=this.mainClips.flatMap(c=>c.getRandomPath()),e=this.currentMainClips.shift())),!e)throw new Error("No clip found");this.emit(i?"outcome-start":"main-start"),await this.seamlessPlayer.play(e),this.currentOutcomeClips||this.emit(i?"outcome-end":"main-end")}async load(){await this.seamlessPlayer.load()}}class k{constructor(t){h(this,"src");h(this,"audio",new Audio);this.src=t}load(){return this.audio.preload="auto",this.audio.autoplay=!1,this.audio.src=this.src,this.audio.pause(),new Promise(t=>{const e=()=>{this.audio.removeEventListener("canplay",e);const i=()=>{this.audio.removeEventListener("canplaythrough",i),t(this.audio)};this.audio.addEventListener("canplaythrough",i)};this.audio.addEventListener("canplay",e)})}}class W{constructor({main:t,outcome:e}){h(this,"mainAudio");h(this,"outcomeAudio");this.mainAudio=new k(t),this.mainAudio.audio.loop=!0,this.outcomeAudio=e.map(i=>new k(i))}play(){this.mainAudio.audio.play()}playOutcome(){if(this.outcomeAudio.length===0)return;const t=Math.floor(Math.random()*this.outcomeAudio.length);this.outcomeAudio[t].audio.play()}async load(){await Promise.all([this.mainAudio.load(),...this.outcomeAudio.map(t=>t.load())])}}class _{constructor(t,e=[]){h(this,"value");h(this,"children",[]);this.value=t,this.children=e}static fromObject(t){return j(t)?new _(t.value,t.children.map(_.fromObject)):new _(t)}*[Symbol.iterator](){yield this;for(const t of this.children)yield*t}convert(t){return new _(t(this.value),this.children.map(e=>e.convert(t)))}traverse(t){t(this);for(const e of this.children)e.traverse(t)}getAllValues(){return[...this].map(t=>t.value)}getRandomPath(){return[this.value,...this.children.length>0?this.children[Math.floor(Math.random()*this.children.length)].getRandomPath():[]]}}function j(n){return!!n&&typeof n=="object"&&"value"in n&&"children"in n}const g=P.parseJsonFromUrl()||{mainClips:["dice/Idle01.mp4","dice/Idle02.mp4"],outcomeClips:[{value:"dice/Dice01.mp4",children:["dice/D01_Like01.mp4","dice/D01_Like02.mp4","dice/D01_Dislike01.mp4","dice/D01_Dislike02.mp4"]},{value:"dice/Dice02.mp4",children:["dice/D02_Like01.mp4","dice/D02_Like02.mp4","dice/D02_Dislike01.mp4","dice/D02_Dislike02.mp4"]},{value:"dice/Dice03.mp4",children:["dice/D03_Like01.mp4","dice/D03_Like02.mp4","dice/D03_Dislike01.mp4","dice/D03_Dislike02.mp4"]},{value:"dice/Dice04.mp4",children:["dice/D04_Like01.mp4","dice/D04_Like02.mp4","dice/D04_Dislike01.mp4","dice/D04_Dislike02.mp4"]},{value:"dice/Dice05.mp4",children:["dice/D05_Like01.mp4","dice/D05_Like02.mp4","dice/D05_Dislike01.mp4","dice/D05_Dislike02.mp4"]},{value:"dice/Dice06.mp4",children:["dice/D06_Like01.mp4","dice/D06_Like02.mp4","dice/D06_Dislike01.mp4","dice/D06_Dislike02.mp4"]}],sounds:{main:"dice/AmbPirateShip_BW.51895.wav",outcome:[]}},L=new R({mainClips:(g==null?void 0:g.mainClips).map(n=>_.fromObject(n)),outcomeClips:(g==null?void 0:g.outcomeClips).map(n=>_.fromObject(n))},document.getElementById("app")),I=new W(g.sounds),x=document.getElementById("controls"),N=document.getElementsByClassName("svg-player")[0];N.classList.add("hidden");const O=document.getElementById("play");O.addEventListener("click",async()=>{O.disabled=!0,O.children[0].classList.remove("fa-play"),O.children[0].classList.add("fa-rotate-right","fa-spin"),await Promise.all([L.load(),I.load()]),N.classList.remove("hidden"),x.classList.remove("hidden"),O.remove(),L.play(),I.play();const n=document.getElementById("throw");n.addEventListener("click",()=>{var t;n.disabled=!0,(t=n.children.item(0))==null||t.classList.add("fa-spin"),L.once("outcome-start",()=>{I.playOutcome()}),L.playOutcome(Math.floor(Math.random()*g.outcomeClips.length)),L.once("outcome-end",()=>{var e;n.disabled=!1,(e=n.children.item(0))==null||e.classList.remove("fa-spin")})})});L.on("resize",({width:n,height:t})=>{x.style.width=`${n}px`,x.style.height=`${t}px`});new P(g,document.getElementById("console"),document.getElementById("json-input"),document.getElementById("apply-btn"),document.getElementById("reset-btn"));
